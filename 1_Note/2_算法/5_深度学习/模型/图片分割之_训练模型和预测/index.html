<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>图片分割之_训练模型和预测 | Yan 的杂物志</title><meta name="author" content="Yan.xie"><meta name="copyright" content="Yan.xie"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="图片分割之_训练模型和预测 #图形图像 #深度学习 1. 说明  本篇使用Mask R-CNN算法，以及十几张从网络上下载的香蕉图片，训练一个模型。用于识别图像中的香蕉，不同于苹果，桔子，香蕉从不同的角度看差异很大，尤其是三五根香蕉放连在一起，或者整把香蕉的形态和单根香蕉差异很大。可以算是一种识别起来相对困难的水平。  下图是用训练好的模型识别出的香蕉图片，可以看到，基本识别正确。   操作步骤可">
<meta property="og:type" content="article">
<meta property="og:title" content="图片分割之_训练模型和预测">
<meta property="og:url" content="http://example.com/1_Note/2_%E7%AE%97%E6%B3%95/5_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%A8%A1%E5%9E%8B/%E5%9B%BE%E7%89%87%E5%88%86%E5%89%B2%E4%B9%8B_%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B%E5%92%8C%E9%A2%84%E6%B5%8B/index.html">
<meta property="og:site_name" content="Yan 的杂物志">
<meta property="og:description" content="图片分割之_训练模型和预测 #图形图像 #深度学习 1. 说明  本篇使用Mask R-CNN算法，以及十几张从网络上下载的香蕉图片，训练一个模型。用于识别图像中的香蕉，不同于苹果，桔子，香蕉从不同的角度看差异很大，尤其是三五根香蕉放连在一起，或者整把香蕉的形态和单根香蕉差异很大。可以算是一种识别起来相对困难的水平。  下图是用训练好的模型识别出的香蕉图片，可以看到，基本识别正确。   操作步骤可">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/blog_logo.png">
<meta property="article:published_time" content="2019-02-03T08:26:59.000Z">
<meta property="article:modified_time" content="2023-09-29T05:34:16.927Z">
<meta property="article:author" content="Yan.xie">
<meta property="article:tag" content="深度学习">
<meta property="article:tag" content="图形图像">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/blog_logo.png"><link rel="shortcut icon" href="/img/blog_logo.png"><link rel="canonical" href="http://example.com/1_Note/2_%E7%AE%97%E6%B3%95/5_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%A8%A1%E5%9E%8B/%E5%9B%BE%E7%89%87%E5%88%86%E5%89%B2%E4%B9%8B_%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B%E5%92%8C%E9%A2%84%E6%B5%8B/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '图片分割之_训练模型和预测',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-29 05:34:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="referrer" content="no-referrer"/><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/blog_logo.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">526</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">65</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Yan 的杂物志"><span class="site-name">Yan 的杂物志</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">图片分割之_训练模型和预测</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2019-02-03T08:26:59.000Z" title="Created 2019-02-03 08:26:59">2019-02-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-09-29T05:34:16.927Z" title="Updated 2023-09-29 05:34:16">2023-09-29</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">2.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>10min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="图片分割之_训练模型和预测"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="图片分割之_训练模型和预测">图片分割之_训练模型和预测</h1>
<p>#图形图像 #深度学习</p>
<h3 id="说明">1. 说明</h3>
<p> 本篇使用Mask
R-CNN算法，以及十几张从网络上下载的香蕉图片，训练一个模型。用于识别图像中的香蕉，不同于苹果，桔子，香蕉从不同的角度看差异很大，尤其是三五根香蕉放连在一起，或者整把香蕉的形态和单根香蕉差异很大。可以算是一种识别起来相对困难的水平。</p>
<p> 下图是用训练好的模型识别出的香蕉图片，可以看到，基本识别正确。</p>
<p><img
src="https://upload-images.jianshu.io/upload_images/5357893-da5f08774d71ba21.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" /></p>
<p> 操作步骤可分为：安装工具，标注图片，修改源码，模型训练和模型预测。我的工作环境是Ubuntu，硬件有GPU支持，操作过程中使用了python，图片标注工具，以及shell脚本。</p>
<h3 id="安装工具">2. 安装工具</h3>
<p><strong>(1) 下载程序源码</strong></p>
<pre><code>$ git clone https://github.com/matterport/Mask_RCNN.git # (大概200多M)  </code></pre>
<p><strong>(2) 下载相关软件</strong></p>
<pre><code>$ sudo pip install opencv-python  
$ sudo pip install tensorflow  
$ sudo pip install scikit-image  
$ sudo pip install keras==2.0.8  
$ sudo pip install labelme # 标注工具  </code></pre>
<h3 id="标注图片">3. 标注图片</h3>
<p><strong>(1) 收集图片</strong></p>
<p> 香蕉图片可以从网上下载，也可用手机拍照，图片分辨率不用太高，1000x1000以下即可，如果分辨率太高，可用linux中的convert命令缩放。我使用的15张图片如下图所示：</p>
<p><img
src="https://upload-images.jianshu.io/upload_images/5357893-34ace3d326fab314.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" /></p>
<p> 需要注意的是，图片需要包括香蕉的各个角度，以及常见的多根组合的几种形态。</p>
<p><strong>(2) 用软件标注图片</strong></p>
<pre><code>$ labelme 图片文件名.jpg  </code></pre>
<p> labelme为一个图形化的标注工具，使用左侧面板中的create
polygons，将图片中所需识别的香蕉圈出来，如果某个点画错了，用Backspace可删除最后设置的点（用法类似于photoshop中的多边形套锁工具），标注完加入填入label名，这个名字后面在程序中会到，标注完注意保存文件，文件名默认为：图片名.json。锚点的细密程度请参考下图：</p>
<p><img
src="https://upload-images.jianshu.io/upload_images/5357893-2efff38ca0d65f21.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" /></p>
<p> 标注无需粒度过细，Labelme工具比较智能，只要位置相近，就能把锚点自动贴近边界。好的工具让标注事半功倍，一般情况下，十几张图片半个多小时即可标注完成，另外，一个图中也可标注多个区域，label名都设置为banana即可。</p>
<p><strong>(3) 解析和拆分标注文件</strong></p>
<p> 使用labelme自带的 labelme_json_to_dataset 命令工具，可将 json
文件拆分成目录，目录中数据如下：</p>
<p><img
src="https://upload-images.jianshu.io/upload_images/5357893-eaed10a73e92e40d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" /></p>
<p> 一条命令可以转换一个图片，当图片多时，建议使用 shell 脚本处理，shell
脚本示例如下，请根据环境调整。</p>
<pre><code>for file in `ls *.json`  
do  
    echo labelme_json_to_dataset $file  
    labelme_json_to_dataset $file  
done  
mkdir ../labelme_json/  
mv *_json ../labelme_json/  </code></pre>
<p><strong>(4) mask文件转码</strong></p>
<p> 由于不同版本的 labelme
生成的文件格式不同，有的mask是24位色，有的是8位色，用以下python程序看一下图片格式：</p>
<pre><code>from PIL import Image  
img = Image.open(None)  
print(img.mode)  </code></pre>
<p> 如果image.mode是P，即8位彩色图像，直接使用即可，如果是其它格式，使用以下程序将其转换成8位图片：</p>
<pre><code>Img_8 = img.convert(&quot;P&quot;)   
Img_8.save(None)  </code></pre>
<p> 将转换后的图片复制到另一文件夹即可，复制方法请参考以下shell脚本</p>
<pre><code>mkdir ../cv2_mask  
cd ../cv2_mask  
for file in `ls ../labelme_json`  
do  
    echo &#39;cp ../labelme_json/&#39;$file&#39;/label.png &#39;$file.png   
    cp &#39;../ labelme_json /&#39;$file&#39;/label.png&#39; $file.png   
done  </code></pre>
<p><strong>(5) 调整目录结构</strong></p>
<p> 把上述的原图放在pic目录中, 标注文件放在 json 目录中,
拆分后的标注文件放在 labelme_json 目录中，掩码mask放在cv2_mask目录中，
调整之后的目录结构如下图所示：</p>
<p><img
src="https://upload-images.jianshu.io/upload_images/5357893-c75e101e618ef08b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" /></p>
<p> 其中的 mine
本例中所有程序和数据，数据放在data目录中，训练好的模型放在models目录中。</p>
<h3 id="训练和预测">4. 训练和预测</h3>
<p><strong>(1) 训练模型</strong></p>
<p><strong>源码</strong></p>
<pre><code>import os  
import sys  
sys.path.append(xxxx) # 加入Mask_RCNN源码所在目录  
import random  
import math  
import re  
import time  
import numpy as np  
import cv2  
import matplotlib  
import matplotlib.pyplot as plt  
import tensorflow as tf  
from mrcnn.config import Config  
from mrcnn import model as modellib,utils  
from mrcnn import visualize  
import yaml  
from mrcnn.model import log  
from PIL import Image  
  
ROOT_DIR = os.getcwd()  
MODEL_DIR = os.path.join(ROOT_DIR, &quot;models&quot;)  
iter_num=0  
COCO_MODEL_PATH = os.path.join(ROOT_DIR, &quot;mask_rcnn_coco.h5&quot;)  
  
# 从网上下载训练好的基础模型  
if not os.path.exists(COCO_MODEL_PATH):  
    utils.download_trained_weights(COCO_MODEL_PATH)  
  
# 配置  
class ShapesConfig(Config):  
    NAME = &quot;shapes&quot; # 命名  
    GPU_COUNT = 1  
    IMAGES_PER_GPU = 1  
    NUM_CLASSES = 1 + 1  # 背景一类，香蕉一类，共两类  
    IMAGE_MIN_DIM = 320  
    IMAGE_MAX_DIM = 384  
    RPN_ANCHOR_SCALES = (8 * 6, 16 * 6, 32 * 6, 64 * 6, 128 * 6)  
    TRAIN_ROIS_PER_IMAGE = 100 # Aim to allow ROI sampling to pick 33% positive ROIs  
    STEPS_PER_EPOCH = 100  
    VALIDATION_STEPS = 50  
  
config = ShapesConfig()  
config.display()  
  
# 重写数据集  
class DrugDataset(utils.Dataset):  
    def get_obj_index(self, image):  
        n = np.max(image)  
        return n  
  
    # 获取标签  
    def from_yaml_get_class(self, image_id):  
        info = self.image_info[image_id]  
        with open(info[&#39;yaml_path&#39;]) as f:  
            temp = yaml.load(f.read())  
            labels = temp[&#39;label_names&#39;]  
            del labels[0]  
        return labels  
  
    # 填充mask  
    def draw_mask(self, num_obj, mask, image,image_id):  
        info = self.image_info[image_id]  
        for index in range(num_obj):  
            for i in range(info[&#39;width&#39;]):  
                for j in range(info[&#39;height&#39;]):  
                    at_pixel = image.getpixel((i, j))  
                    if at_pixel == index + 1:  
                        mask[j, i, index] = 1  
        return mask  
      
    # 读入训练图片及其配置文件  
    def load_shapes(self, count, img_floder, mask_floder, imglist, dataset_root_path):  
        self.add_class(&quot;shapes&quot;, 1, &quot;banana&quot;) # 自定义标签   
        for i in range(count):  
            filestr = imglist[i].split(&quot;.&quot;)[0]  
            mask_path = mask_floder + &quot;/&quot; + filestr + &quot;_json.png&quot;  
            yaml_path = dataset_root_path + &quot;labelme_json/&quot; + filestr + &quot;_json/info.yaml&quot;  
            cv_img = cv2.imread(None)  
            self.add_image(&quot;shapes&quot;, image_id=i, path=img_floder + &quot;/&quot; + imglist[i],  
                           width=cv_img.shape[1], height=cv_img.shape[0], mask_path=mask_path, yaml_path=yaml_path)  
  
    # 读取标签和配置   
    def load_mask(self, image_id):  
        global iter_num  
        print(&quot;image_id&quot;,image_id)  
        info = self.image_info[image_id]  
        count = 1  # number of object  
        img = Image.open(info[&#39;mask_path&#39;])  
        num_obj = self.get_obj_index(img)  
        mask = np.zeros([info[&#39;height&#39;], info[&#39;width&#39;], num_obj], dtype=np.uint8)  
        mask = self.draw_mask(num_obj, mask, img,image_id)  
        occlusion = np.logical_not(mask[:, :, -1]).astype(np.uint8)  
        for i in range(count - 2, -1, -1):  
            mask[:, :, i] = mask[:, :, i] * occlusion  
            occlusion = np.logical_and(occlusion, np.logical_not(mask[:, :, i]))  
        labels = []  
        labels = self.from_yaml_get_class(image_id)  
        labels_form = []  
        for i in range(len(labels)):  
            if labels[i].find(&quot;banana&quot;) != -1: # 自定义标签  
                labels_form.append(&quot;banana&quot;)  
        class_ids = np.array([self.class_names.index(s) for s in labels_form])  
        return mask, class_ids.astype(np.int32)  
  
#基础设置  
dataset_root_path=&quot;data/&quot;  
img_floder = dataset_root_path + &quot;pic&quot; # 基本图片目录  
mask_floder = dataset_root_path + &quot;cv2_mask&quot; # mask图片目录  
imglist = os.listdir(img_floder)  
count = len(imglist)  
  
# 构造训练集  
dataset_train = DrugDataset()  
dataset_train.load_shapes(count, img_floder, mask_floder, imglist, dataset_root_path)  
dataset_train.prepare()  
  
# 构造验证集  
dataset_val = DrugDataset()  
dataset_val.load_shapes(7, img_floder, mask_floder, imglist, dataset_root_path)  
dataset_val.prepare()  
  
# 建立模型  
model = modellib.MaskRCNN(mode=&quot;training&quot;, config=config,  
                          model_dir=MODEL_DIR)  
  
# 定义模式  
init_with = &quot;coco&quot;  # imagenet, coco, or last  
  
if init_with == &quot;imagenet&quot;:  
    model.load_weights(model.get_imagenet_weights(), by_name=True)  
elif init_with == &quot;coco&quot;:  
    model.load_weights(COCO_MODEL_PATH, by_name=True,  
                       exclude=[&quot;mrcnn_class_logits&quot;, &quot;mrcnn_bbox_fc&quot;,  
                                &quot;mrcnn_bbox&quot;, &quot;mrcnn_mask&quot;])  
elif init_with == &quot;last&quot;:  
    model.load_weights(model.find_last()[1], by_name=True)  
  
model.train(dataset_train, dataset_val,  
            learning_rate=config.LEARNING_RATE,  
            epochs=10,  
            layers=&#39;heads&#39;)  
  
model.train(dataset_train, dataset_val,  
            learning_rate=config.LEARNING_RATE / 10,  
            epochs=30,  
            layers=&quot;all&quot;)  
  </code></pre>
<p><strong>运行程序</strong></p>
<pre><code>$ python train.py  </code></pre>
<p> 在程序运行过程中，如果因为tensorflow版本与mask_rcnn不匹配，引起找不到keepdims问题，需要修改
Mask_RCNN/mrcnn/model.py，将其中的keepdims改为keep_dims即可。<br />
 我的机器训练完不到15分钟，如果把两次训练的迭代次数分别设成1和2则2分钟完成训练。</p>
<p><strong>(2) 预测模型</strong><br />
<strong>源码</strong></p>
<pre><code># -*- coding: utf-8 -*-  
  
import os  
import sys  
sys.path.append(os.path.dirname(os.getcwd())) # 注意：加mask_rcnn目录  
import skimage.io  
from mrcnn.config import Config  
from datetime import datetime   
import mrcnn.model as modellib  
from mrcnn import visualize  
  
ROOT_DIR = os.getcwd()  
sys.path.append(ROOT_DIR)  
MODEL_DIR = os.path.join(ROOT_DIR, &quot;models&quot;)  
  
# 配置，同train  
class ShapesConfig(Config):  
    NAME = &quot;shapes&quot;  
    GPU_COUNT = 1  
    IMAGES_PER_GPU = 1  
    NUM_CLASSES = 1 + 1  
    IMAGE_MIN_DIM = 320  
    IMAGE_MAX_DIM = 384  
    RPN_ANCHOR_SCALES = (8 * 6, 16 * 6, 32 * 6, 64 * 6, 128 * 6)  
    TRAIN_ROIS_PER_IMAGE =100  
    STEPS_PER_EPOCH = 100  
    VALIDATION_STEPS = 50  
  
class InferenceConfig(ShapesConfig):  
    GPU_COUNT = 1  
    IMAGES_PER_GPU = 1  
  
config = InferenceConfig()  
model = modellib.MaskRCNN(mode=&quot;inference&quot;, model_dir=MODEL_DIR, config=config)  
model.load_weights(&#39;models/shapes20190117T1428/mask_rcnn_shapes_0001.h5&#39;, by_name=True) # 注意换成你模型的路径  
#model.load_weights(&#39;models/shapes20190117T1428/mask_rcnn_shapes_0030.h5&#39;, by_name=True) # 注意换成你模型的路径  
#model.load_weights(&#39;mask_rcnn_coco.h5&#39;, by_name=True) # 注意换成你模型的路径  
  
class_names = [&#39;BG&#39;, &#39;banana&#39;]  
image = skimage.io.imread(None) # 注意事换成你要识别的图片  
  
a=datetime.now()   
results = model.detect([image], verbose=1)  
b=datetime.now()   
print(&quot;@@ detect duration&quot;,(b-a).seconds, &#39;second&#39;)  
r = results[0]  
# 画图  
visualize.display_instances(image, r[&#39;rois&#39;], r[&#39;masks&#39;], r[&#39;class_ids&#39;],   
                            class_names, r[&#39;scores&#39;])  
  </code></pre>
<p><strong>运行程序</strong></p>
<pre><code>$ python test.py  </code></pre>
<h3 id="分析总结">5. 分析总结</h3>
<ul>
<li><p>自动标注：当图片数量很多时，可以先训练少量图片，生成模型，让模型自动标注，人为检查标注是否正确，对于不正确的人工重新标注。</p></li>
<li><p>建议使用GPU：相比GPU，我用4核的CPU计算，速度目测差了50倍左右。个人觉得没有GPU，训练速度几乎是无法接受的。</p></li>
<li><p>迭代次数：迭代次数可以调整，如果同一个图，用网上下载的基础模型完全识别不出。而用第1次迭代和第30次迭代结果差不太多，以后再训练就可以减少迭代次数，以节约时间。</p></li>
<li><p>生成模型：由于迭代训练了30次，models目录下产生了30个模型文件，占空间比较大，不用的可以删除掉。</p></li>
<li><p>更多例程请参考原代码中的 Mask_RCNN/samples/ 目录。</p></li>
</ul>
<h3 id="问题及解决方法">6. 问题及解决方法</h3>
<ul>
<li>问题: 在CPU上运行时可能报错 SVD did not converge ，<br />
分析及解决：该问题发生成resize图片时，代码mrcnn/utils.py计算resize的scale里用两个int型相除，结果scale变成0，导致resize出错，解决访问是添加：scale
= float(max_dim) / image_max 强制类型转型即可。</li>
</ul>
<h3 id="参考">7. 参考</h3>
<ul>
<li><p>Mask RCNN训练自己的数据集<br />
<a
target="_blank" rel="noopener" href="https://blog.csdn.net/l297969586/article/details/79140840">https://blog.csdn.net/l297969586/article/details/79140840</a></p></li>
<li><p>mask rcnn训练自己的数据集<br />
<a
target="_blank" rel="noopener" href="https://blog.csdn.net/qq_29462849/article/details/81037343">https://blog.csdn.net/qq_29462849/article/details/81037343</a></p></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://example.com">Yan.xie</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/1_Note/2_%E7%AE%97%E6%B3%95/5_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%A8%A1%E5%9E%8B/%E5%9B%BE%E7%89%87%E5%88%86%E5%89%B2%E4%B9%8B_%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B%E5%92%8C%E9%A2%84%E6%B5%8B/">http://example.com/1_Note/2_%E7%AE%97%E6%B3%95/5_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%A8%A1%E5%9E%8B/%E5%9B%BE%E7%89%87%E5%88%86%E5%89%B2%E4%B9%8B_%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B%E5%92%8C%E9%A2%84%E6%B5%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">深度学习</a><a class="post-meta__tags" href="/tags/%E5%9B%BE%E5%BD%A2%E5%9B%BE%E5%83%8F/">图形图像</a></div><div class="post_share"><div class="social-share" data-image="/img/blog_logo.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/1_Note/2_%E7%AE%97%E6%B3%95/5_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%A8%A1%E5%9E%8B/%E8%BF%81%E7%A7%BB%E5%AD%A6%E4%B9%A0%E4%B9%8B_%E7%8C%AB%E7%8B%97%E5%A4%A7%E6%88%98/" title="迁移学习之_猫狗大战"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">迁移学习之_猫狗大战</div></div></a></div><div class="next-post pull-right"><a href="/1_Note/3_%E7%BC%96%E7%A8%8B/Python/%E5%B7%A5%E5%85%B7/%E5%B8%B8%E7%94%A8%E7%9A%84%E8%89%B2%E6%9D%BF/" title="常用的色板"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">常用的色板</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/1_Note/2_%E7%AE%97%E6%B3%95/8_%E5%9B%BE%E5%BD%A2%E5%9B%BE%E5%83%8F/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB_%E5%9B%BE%E5%83%8F%E7%94%9F%E6%88%90_unCLIP/" title="论文阅读_图像生成_unCLIP"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-15</div><div class="title">论文阅读_图像生成_unCLIP</div></div></a></div><div><a href="/1_Note/2_%E7%AE%97%E6%B3%95/5_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%A8%A1%E5%9E%8B/%E6%AE%8B%E5%B7%AE%E7%BD%91%E7%BB%9CResNet%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB/" title="残差网络ResNet代码解读"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-11-25</div><div class="title">残差网络ResNet代码解读</div></div></a></div><div><a href="/1_Note/2_%E7%AE%97%E6%B3%95/5_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%A8%A1%E5%9E%8B/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0_%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9CCNN/" title="深度学习_卷积神经网络CNN"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-11-03</div><div class="title">深度学习_卷积神经网络CNN</div></div></a></div><div><a href="/2_Knowledge/2_%E6%8A%80%E6%9C%AF/%E4%B8%BB%E9%A2%98%E7%AC%94%E8%AE%B0_%E6%A8%A1%E5%9E%8B%E5%8E%8B%E7%BC%A9/" title="深度学习模型压缩"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-24</div><div class="title">深度学习模型压缩</div></div></a></div><div><a href="/1_Note/0_%E5%B7%A5%E5%85%B7/Docker/Docker%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" title="nvidia-docker无法正常启动"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-01</div><div class="title">nvidia-docker无法正常启动</div></div></a></div><div><a href="/1_Note/0_%E5%B7%A5%E5%85%B7/Docker/%E6%90%AD%E5%BB%BATensorFlow%E7%9A%84GPUDocker%E7%8E%AF%E5%A2%83/" title="搭建TensorFlow的GPUDocker环境"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-19</div><div class="title">搭建TensorFlow的GPUDocker环境</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/blog_logo.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Yan.xie</div><div class="author-info__description">顺流而下还是逆流而上？</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">526</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">65</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%BE%E7%89%87%E5%88%86%E5%89%B2%E4%B9%8B_%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B%E5%92%8C%E9%A2%84%E6%B5%8B"><span class="toc-number">1.</span> <span class="toc-text">图片分割之_训练模型和预测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-number">1.0.1.</span> <span class="toc-text">1. 说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%B7%A5%E5%85%B7"><span class="toc-number">1.0.2.</span> <span class="toc-text">2. 安装工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E6%B3%A8%E5%9B%BE%E7%89%87"><span class="toc-number">1.0.3.</span> <span class="toc-text">3. 标注图片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83%E5%92%8C%E9%A2%84%E6%B5%8B"><span class="toc-number">1.0.4.</span> <span class="toc-text">4. 训练和预测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E6%80%BB%E7%BB%93"><span class="toc-number">1.0.5.</span> <span class="toc-text">5. 分析总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="toc-number">1.0.6.</span> <span class="toc-text">6. 问题及解决方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">1.0.7.</span> <span class="toc-text">7. 参考</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/1_Note/0_%E5%B7%A5%E5%85%B7/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E5%85%B7/%E6%B2%89%E6%B5%B8%E5%BC%8F%E7%BF%BB%E8%AF%91/" title="沉浸式翻译">沉浸式翻译</a><time datetime="2023-09-29T00:00:00.000Z" title="Created 2023-09-29 00:00:00">2023-09-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/1_Note/4_%E7%B3%BB%E7%BB%9F/Linux/CentOS%E7%B3%BB%E7%BB%9F/" title="CentOS系统">CentOS系统</a><time datetime="2023-09-28T00:00:00.000Z" title="Created 2023-09-28 00:00:00">2023-09-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/1_Note/4_%E7%B3%BB%E7%BB%9F/Linux/Ubuntu%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2_%E5%90%91%E6%97%A5%E8%91%B5/" title="Ubuntu远程桌面_向日葵">Ubuntu远程桌面_向日葵</a><time datetime="2023-09-28T00:00:00.000Z" title="Created 2023-09-28 00:00:00">2023-09-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/0_Inbox/1_%E6%AD%A3%E5%9C%A8%E5%81%9A/django/Django_1_%E5%85%A5%E9%97%A8/" title="Django_1_入门">Django_1_入门</a><time datetime="2023-09-19T00:00:00.000Z" title="Created 2023-09-19 00:00:00">2023-09-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/0_Inbox/1_%E6%AD%A3%E5%9C%A8%E5%81%9A/django/Django_2_%E8%BF%9B%E9%98%B6/" title="Django_2_进阶">Django_2_进阶</a><time datetime="2023-09-19T00:00:00.000Z" title="Created 2023-09-19 00:00:00">2023-09-19</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Yan.xie</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>